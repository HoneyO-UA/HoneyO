# Input Section
input {
    file {
        path => ["${LOGSTASH_INPUT_PATH}"]
        codec => json
        type => "LB-Network"
    }
    
    file {
        path => ["/data/p0f/log/p0f.json"]
        codec => json
        type => "P0f"
    }
}

# Filter Section
filter {
    if [type] == "LB-Network" {
        # date {
        #     match => [ "timestamp", "ISO8601" ]
        #     remove_field => ["unixtime"]
        # }
        if ![layers][tcp] or ![layers][ip] {
            drop {}
        }

        if [layers][tcp] and [layers][ip] {
            mutate {
                add_field => {
                    "src_ip" => "%{[layers][ip][ip_ip_src]}"
                    "src_port" => "%{[layers][tcp][tcp_tcp_srcport]}"
                    "dest_ip" => "%{[layers][ip][ip_ip_dst]}"
                    "dest_port" => "%{[layers][tcp][tcp_tcp_dstport]}"
                }
                # remove_field => ["ip"]
                # remove_field => ["tcp"]
            }
        }
        mutate{
            remove_field => ["layers"]
        }
        # To test 2.80.150.12
        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*0$/ {
            mutate{
                replace => {
                    "src_ip" => "46.17.46.213" # Russia
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*0$/ {
            mutate{
                replace => {
                    "dest_ip" => "46.17.46.213" # Russia
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*1$/ {
            mutate{
                replace => {
                    "src_ip" => "69.162.81.155" # EUA
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*1$/ {
            mutate{
                replace => {
                    "dest_ip" => "69.162.81.155" # EUA
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*2$/ {
            mutate{
                replace => {
                    "src_ip" => "110.33.122.75" # Australia
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*2$/ {
            mutate{
                replace => {
                    "dest_ip" => "110.33.122.75" # Australia
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*3$/ {
            mutate{
                replace => {
                    "src_ip" => "177.192.255.38" # Brazil
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*3$/ {
            mutate{
                replace => {
                    "dest_ip" => "177.192.255.38" # Brazil
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*4$/ {
            mutate{
                replace => {
                    "src_ip" => "221.192.199.49" # China
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*4$/ {
            mutate{
                replace => {
                    "dest_ip" => "221.192.199.49" # China
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*5$/ {
            mutate{
                replace => {
                    "src_ip" => "176.31.84.249" # France
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*5$/ {
            mutate{
                replace => {
                    "dest_ip" => "176.31.84.249" # France
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*6$/ {
            mutate{
                replace => {
                    "src_ip" => "115.240.90.163" # India
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*6$/ {
            mutate{
                replace => {
                    "dest_ip" => "115.240.90.163" # India
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*7$/ {
            mutate{
                replace => {
                    "src_ip" => "192.36.27.7" # Denmark
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*7$/ {
            mutate{
                replace => {
                    "dest_ip" => "192.36.27.7" # Denmark
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*8$/ {
            mutate{
                replace => {
                    "src_ip" => "196.21.247.1" # South Africa
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*8$/ {
            mutate{
                replace => {
                    "dest_ip" => "196.21.247.1" # South Africa
                }
            }
        }
######################################################################################

        if [src_ip] =~ /^172.16.*/ and [timestamp] =~/.*9$/ {
            mutate{
                replace => {
                    "src_ip" => "178.238.11.6" # UK
                }
            }
        }

        if [dest_ip] =~ /^172.16.*/ and [timestamp] =~/.*9$/ {
            mutate{
                replace => {
                    "dest_ip" => "178.238.11.6" # UK
                }
            }
        }
    }
    
    if [type] == "P0f" {
        date {
            match => [ "timestamp", "yyyy'/'MM'/'dd HH:mm:ss" ]
            remove_field => ["timestamp"]
        }
        mutate {
        rename => {
            "server_port" => "dest_port"
            "server_ip" => "dest_ip"
            "client_port" => "src_port"
            "client_ip" => "src_ip"
        }
        }
    }


    if "_grokparsefailure" in [tags] { drop {} }
    if "_jsonparsefailure" in [tags] { drop {} }

    mutate {
        add_field => {
            "t-pot_ip_ext" => "${EXTERNAL_IP}"
            "t-pot_ip_int" => "${INTERNAL_IP}"
            "t-pot_hostname" => "${HOSTNAME}"
        }
    }

# Add geo coordinates / ASN info / IP rep.
    if [src_ip] {
        geoip {
            cache_size => 10000
            source => "src_ip"
            default_database_type => "City"
        }
        geoip {
            cache_size => 10000
            source => "src_ip"
            default_database_type => "ASN"
        }
        translate {
            refresh_interval => 86400
            source => "src_ip"
            target => "ip_rep"
            dictionary_path => "/etc/logstash/iprep.yaml"
        }
  }
  if [t-pot_ip_ext]  {
    geoip {
      cache_size => 10000
      source => "t-pot_ip_ext"
      target => "geoip_ext"
      default_database_type => "City"
#      database => "/usr/share/logstash/vendor/bundle/jruby/2.6.0/gems/logstash-filter-geoip-7.2.12-java/vendor/GeoLite2-City.mmdb"
    }
    geoip {
      cache_size => 10000
      source => "t-pot_ip_ext"
      target => "geoip_ext"
      default_database_type => "ASN"
#      database => "/usr/share/logstash/vendor/bundle/jruby/2.6.0/gems/logstash-filter-geoip-7.2.12-java/vendor/GeoLite2-ASN.mmdb"
    }
  }

    if [dest_port] {
        mutate {
            convert => { "dest_port" => "integer" }
        }
    }
    if [src_port] {
        mutate {
            convert => { "src_port" => "integer" }
        }
    }
    if [status] {
        mutate {
            convert => { "status" => "integer" }
        }
    }
    if [id] {
        mutate {
            convert => { "id" => "string" }
        }
    }
    if [request] {
        mutate {
            convert => { "request" => "string" }
        }
    }

    if [dest_ip] != "10.255.37.49" {
            drop {}
    }

    if [dest_port] == 80 {
        mutate {
            add_field => {
                "honeypot" => "Web Service"
            }
        }
    }
    if [dest_port] != 80 {
        mutate {
            add_field => {
                "honeypot" => "SSH Service"
            }
        }
    }
}


# Output section
output {
  elasticsearch {
    hosts => ["${ES_HOST}:9200"]
    # With templates now being legacy we need to set the daily index with its template manually. Otherwise a new index might be created with differents settings configured through Kibana.
    index => "logstash-%{+YYYY.MM.dd}"
    template => "/etc/logstash/template.json"
    template_overwrite => "true"
  }
}